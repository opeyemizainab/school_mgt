{% extends "base.html" %}
{% block title %}My Results{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>My Results</h2>
    <p class="text-muted">{{ student.user.get_full_name }}</p>

    <!-- Filter Form -->
    <form method="get" class="row g-3 mb-4">
        <div class="col-md-4">
            <label for="session" class="form-label">Session</label>
            <select name="session" id="session" class="form-select">
                <option value="">Select Session</option>
                {% for sess in sessions %}
                    <option value="{{ sess.id }}" {% if selected_session == sess.id|stringformat:"s" %}selected{% endif %}>
                        {{ sess.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label for="term" class="form-label">Term</label>
            <select name="term" id="term" class="form-select">
                <option value="">Select Term</option>
                {% for trm in terms %}
                    <option value="{{ trm.id }}" {% if selected_term == trm.id|stringformat:"s" %}selected{% endif %}>
                        {{ trm.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-filter"></i> Apply Filter
            </button>
        </div>
    </form>

    <!-- Show Results Only If Filters Are Applied -->
    {% if selected_session or selected_term %}
        <div class="d-flex justify-content-between mb-3">
            <h5>Showing results for:
                <span class="text-primary">
                    {{ selected_session|default:"All Sessions" }}
                </span> /
                <span class="text-primary">
                    {{ selected_term|default:"All Terms" }}
                </span>
            </h5>

            <!-- Download PDF -->
            {% if results %}
                <a href="?session={{ selected_session }}&term={{ selected_term }}&download=pdf"
                   class="btn btn-success">
                    <i class="bi bi-download"></i> Download PDF
                </a>
            {% endif %}
        </div>

        <!-- Results Table -->
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Subject</th>
                        <th>Test Score</th>
                        <th>Exam Score</th>
                        <th>Total</th>
                        <th>Grade</th>
                        <th>Comment</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr>
                        <td>{{ result.subject.name }}</td>
                        <td>{{ result.test_score }}</td>
                        <td>{{ result.exam_score }}</td>
                        <td>{{ result.total_score }}</td>
                        <td>{{ result.grade }}</td>
                        <td>{{ result.comment }}</td>
                        <td>
                            {% if result.locked %}
                                <span class="badge bg-danger">Locked</span>
                            {% else %}
                                <span class="badge bg-success">Unlocked</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">No results found for the selected filters.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-center text-muted mt-3">
            Please select a <strong>Session</strong> and/or <strong>Term</strong> to view results.
        </p>
    {% endif %}

    <!-- Back to dashboard button -->
    <div class="mt-3">
        <a href="{% url 'student_dashboard' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
